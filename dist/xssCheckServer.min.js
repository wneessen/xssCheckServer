"use strict";var wpObj=require("webpage").create(),wsObj=require("webserver").create(),sysObj=require("system"),versionNum="1.1.1",debugMode=!1,returnResErrors=!1;wpObj.settings.userAgent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36 xssCheckServer/"+versionNum,wpObj.settings.XSSAuditingEnabled=!1,wpObj.settings.webSecurityEnabled=!1,wpObj.settings.loadImages=!1,wpObj.settings.javascriptEnabled=!0,wpObj.settings.localToRemoteUrlAccessEnabled=!0,wpObj.settings.resourceTimeout=3e3;var resBlockList=["googletagmanager.com","google-analytics.com","optimizely.com",".amazon-adsystem.com","device-metrics-us.amazon.com","crashlytics.com","doubleclick.net"],resErrorIgnoreList=[5,301],listenHost="127.0.0.1",listenPort="8099",cliArgs=sysObj.args;cliArgs.forEach(function(e,s){if(e.match(/^-/)&&"-"!==e){var t=cliArgs[s],r=cliArgs[s+1];if("-h"===t&&(console.log("Usage: "+sysObj.args[0]+" [-l 127.0.0.1, -p 8099, -d, -h]"),phantom.exit(0)),"-l"===t&&(listenHost=r),"-p"===t&&(listenPort=r),"-d"===t&&(debugMode=!0),"-b"===t){var o=r;o.split(",").forEach(function(e){resBlockList.push(e)})}}}),console.log("This is xssCheckServer v"+versionNum),console.log("Starting webserver on http://"+listenHost+":"+listenPort);var webService=wsObj.listen(listenHost+":"+listenPort,function(e,s){var t=new Date,r=Date.now(),o={alertOnAnyEvent:!1,checkUrl:null,queryString:null,reqMethod:"GET",searchString:"XSSed!"},a={requestTime:0,statusMsg:null,statusCode:0},n={blockedUrls:[],checkTime:t,responseData:a,requestData:o,hasXss:!1,xssData:[],resourceErrors:[]},u=function(e,s){debugMode&&(console.log("An event has been executed on "+n.requestData.checkUrl),console.log('==> EventType: "'+e+'" // EventData: "'+s+'"')),s!==n.requestData.searchString&&!0!==n.requestData.alertOnAnyEvent||(debugMode&&console.log('Possible XSS! The eventMsg matches the search string: "'+n.requestData.searchString+'"\n'),n.hasXss=!0,n.xssData.push({eventType:e,eventMsg:s}))};wpObj.onAlert=function(e){u("alert()",e)},wpObj.onConfirm=function(e){u("confirm()",e)},wpObj.onConsoleMessage=function(e){u("console.log()",e)},wpObj.onPrompt=function(e){u("prompt()",e)},wpObj.onError=debugMode?function(e){console.error("An error was caught: "+e)}:function(){},wpObj.onResourceRequested=function(e,s){var t=function(s){var t=new RegExp(s,"g");return e.url.match(t)};resBlockList.some(t)&&(debugMode&&console.log(e.url+" is blocklisted. Not loading resource."),n.blockedUrls.push(e.url),s.abort())},wpObj.onResourceError=function(e){debugMode&&(console.error("Unable to load resource (#"+e.id.toString()+" => URL:"+e.url+")"),console.error("Error code: "+e.errorCode+". Description: "+e.errorString)),returnResErrors&&-1===resErrorIgnoreList.indexOf(parseInt(e.errorCode))&&n.resourceErrors.push({url:e.url,errorCode:e.errorCode,errorString:e.errorString})},debugMode&&(console.log("Received new HTTP request"),console.log("Method: "+e.method),console.log("Path: "+e.url),e.post&&console.log("postData: "+JSON.stringify(e.post)),console.log(" ")),"/check"===e.url?"POST"===e.method?(e.post.searchfor&&(n.requestData.searchString=e.post.searchfor),e.post.everyevent&&"true"===e.post.everyevent&&(n.requestData.alertOnAnyEvent=!0),e.post.reqmethod&&("POST"!==e.post.reqmethod.toUpperCase()&&"GET"!==e.post.reqmethod.toUpperCase()?n.requestData.reqMethod=e.post.reqmethod.toUpperCase()+"_NOT_SUPPORTED":n.requestData.reqMethod=e.post.reqmethod.toUpperCase()),e.post.url&&(n.requestData.checkUrl=e.post.url),e.post.querystring&&(n.requestData.queryString=e.post.querystring),!n.requestData.checkUrl||""===n.requestData.checkUrl||"INVALID"===n.requestData.reqMethod||null===n.requestData.queryString&&!1===n.requestData.alertOnAnyEvent?(s.statusCode=400,n.responseData.statusCode=400,n.responseData.errorMsg="Missing request parameters",s.write(JSON.stringify(n)),s.close()):"GET"===n.requestData.reqMethod?wpObj.open(n.requestData.checkUrl+"?"+n.requestData.queryString,function(e){r=Date.now()-r,"success"!==e?(debugMode&&console.error("Unable to download URL: "+n.requestData.checkUrl),n.responseData.statusCode=500,n.responseData.statusMsg=e,n.responseData.errorMsg="Unabled to download provided URL"):(n.responseData.statusCode=200,n.responseData.statusMsg=e,wpObj.evaluate(function(){})),n.responseData.requestTime=r,debugMode&&console.log("Request completed in "+r/1e3+" sec"),s.statusCode=200,s.write(JSON.stringify(n)),s.close()}):"POST"===n.requestData.reqMethod&&wpObj.open(n.requestData.checkUrl,"POST",n.requestData.queryString,function(e){r=Date.now()-r,"success"!==e?(debugMode&&console.error("Unable to download URL: "+n.requestData.checkUrl),n.responseData.statusCode=500,n.responseData.statusMsg=e,n.responseData.errorMsg="Unabled to download provided URL"):(n.responseData.statusCode=200,n.responseData.statusMsg=e,wpObj.evaluate(function(){})),n.responseData.requestTime=r,debugMode&&console.log("Request completed in "+r/1e3+" sec"),s.statusCode=200,s.write(JSON.stringify(n)),s.close()})):(s.statusCode=404,n.responseData.statusCode=404,n.responseData.errorMsg="Invalid request method",s.write(JSON.stringify(n)),s.close()):(s.statusCode=404,n.responseData.statusCode=404,n.responseData.errorMsg="Route not found",s.write(JSON.stringify(n)),s.close())});